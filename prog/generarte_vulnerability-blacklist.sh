#!/bin/bash
source /etc/environment
source $PROG/all-scripts-exports.sh
FILTER=/etc/fail2ban/filter.d
IN_FILE=$FILTER/ctp-custom-vars.conf

OUT_FILE=$HOLE/vulnerability-blacklist.regex

! [[ -f $OUT_FILE ]] && touch $OUT_FILE

IP_REGEX='(([0-9]{1,3}((\.)?)){4})'
PTR_REGEX="$IP_REGEX\.in-addr\.arpa((\.)?)"

DOMAIN_LENGTH_REGEX=`grep -E ^DOMAIN_LENGTH_REGEX $IN_FILE | awk -F= '{print $2}'`

DOMAIN_LENGTH_REGEX=${DOMAIN_LENGTH_REGEX// /}
DOMAIN_LENGTH_REGEX_NEW='(^|\\.)'
vulnerability_block_regex=`grep -E ^QUERY_DOMAIN_REGEX_ $IN_FILE | awk -F= '{print $2}'`
vulnerability_block_regex=${vulnerability_block_regex// /}
echo "$vulnerability_block_regex" | sudo tee $OUT_FILE

sed -i "s/<DOMAIN_LENGTH_REGEX>/$DOMAIN_LENGTH_REGEX_NEW/gm" $OUT_FILE
sed -i "s/<IP_REGEX>/$IP_REGEX/gm" $OUT_FILE
sed -i "s/<PTR_REGEX>/$PTR_REGEX/gm" $OUT_FILE
sed -i 's/testip\\.internet-census\\.org|//gm' $OUT_FILE

CTP_LIST=$WWW/txt_lists/ctp-lists
[[ -f $OUT_FILE ]] && [[ -f $CTP_LIST ]] && sudo cp -rf $HOLE/vulnerability-blacklist.regex $CTP_LIST/

sleep 2s
[[ -f $OUT_FILE ]] && cat $OUT_FILE | parallel --lb -j1 echo '{}$' | parallel --lb --xargs -j1 -m pihole --regex '{}'
