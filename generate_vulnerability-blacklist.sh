#!/bin/bash
source /etc/environment
source $PROG/all-scripts-exports.sh
FILTER=/etc/fail2ban/filter.d
IN_FILE=$FILTER/ctp-custom-vars.conf
PIHOLE_REGEX_BLOCKED_QUERY_TYPE=$HOLE/vulnerability-pihole-blocked-query-types.regex
DNSMASQ_CONFIG_FOR_vulnerability_blacklist=$DNSMASQ/14-InfoSec-vulnerability-blacklist.conf
OUT_FILE=$HOLE/vulnerability-blacklist.regex

! [[ -f $OUT_FILE ]] && touch $OUT_FILE

IP_REGEX='((([0-9]{1,3}((\\.)?))){4})'
PTR_REGEX="$IP_REGEX\\.in-addr\\.arpa((\\.)?)"

DOMAIN_LENGTH_REGEX=`grep -E ^DOMAIN_LENGTH_REGEX $IN_FILE | awk -F= '{print $2}'`
WILD_CARD_DOMAIN_REGEX=`grep -E ^WILD_CARD_DOMAIN_REGEX $IN_FILE | awk -F= '{print $2}'`

DOMAIN_LENGTH_REGEX=${DOMAIN_LENGTH_REGEX// /}
WILD_CARD_DOMAIN_REGEX=${WILD_CARD_DOMAIN_REGEX// /}
DOMAIN_LENGTH_REGEX_NEW='(^|\\.)'
vulnerability_block_regex=`grep -E ^QUERY_DOMAIN_REGEX_ $IN_FILE | awk -F= '{print $2}'`
vulnerability_block_regex=${vulnerability_block_regex// /}

echo """# Generated by: $scriptName
# Generated at: `date`
# This reduces system resource usage and log output
# InfoSec blocklist because fucking hacker

""" | sudo tee $OUT_FILE

echo "$vulnerability_block_regex" | sudo tee -a $OUT_FILE

#sed -i 's/)$/)$/gm' $OUT_FILE
#sed -i "s/<WILD_CARD_DOMAIN_REGEX>/$DOMAIN_LENGTH_REGEX_NEW/gm" $OUT_FILE
sed -i "s/^(/$DOMAIN_LENGTH_REGEX_NEW(/gm" $OUT_FILE
sed -i "s/(^\.$)|//gm" $OUT_FILE
sed -i "s/<IP_REGEX>/$IP_REGEX/gm" $OUT_FILE
sed -i "s/<PTR_REGEX>/$PTR_REGEX/gm" $OUT_FILE
sed -i 's/testip\\.internet-census\\.org|//gm' $OUT_FILE

CTP_LIST=$WWW/txt_lists/ctp-lists
[[ -f $OUT_FILE ]] && [[ -d $CTP_LIST ]] && sudo cp -rf $HOLE/vulnerability-blacklist.regex $CTP_LIST/

sleep 2s
if [[ "$IS_MASTER" == 'true' ]] || [[ "$HOSTNAME" == 'ctp-vpn' ]]; then
	[[ -f $OUT_FILE ]] && ccat $OUT_FILE | parallel --lb -j1 echo '{}$' | parallel --lb --xargs -j1 -m pihole --regex '{}'
	[[ -f $PIHOLE_REGEX_BLOCKED_QUERY_TYPE ]] && ccat $PIHOLE_REGEX_BLOCKED_QUERY_TYPE | parallel --lb -j1 echo '{}' | parallel --lb --xargs -j1 -m pihole --regex '{}'


	MAJOR_DOMAINS=(
		pizzaseo.com
		{.,}spiderprobe.com
		query
		{ip.,.,}parrotdns.com
		parrotdns.com
		www.area51.dk
		hitnslab.{site,store}
		sl
		censys-scanner.com
		www.utransit.com
		asert-dns-research.com
		2iotgames.com
		netease.com
		atisserbest.com
		qq
		{porttest.,}dns-oarc.net
		earth.raapid.net
		hm.com
		superability-kooka.{info,org}
		{testip.,}internet-census.{info,org}
		{open-resolver-scan.,}research.icann.org
		www.ac.my.blastodermic-swimmable.info
		www.bibiesse.{info,org}
		aaadns.xyz
		{{anyc.,}research.,}openresolve.rs
		cnametest.ihvdiouwe.ml
		r0.customhosting.ca
		socks.live.bigo.sg
		67b.org
	)
	pihole --regex -d '$'
	pihole -b ${MAJOR_DOMAINS[@]}

	echo """# Generated by: $scriptName
	# Generated at: `date`
	# This reduces system resource usage and log output
	# InfoSec blocklist backup item because fucking hacker
	""" | sudo tee $DNSMASQ_CONFIG_FOR_vulnerability_blacklist

	for domain in "${MAJOR_DOMAINS[@]}"
	do

echo """
local=/$domain/
""" | sudo tee -a $DNSMASQ_CONFIG_FOR_vulnerability_blacklist

	done
fi

pihole --regex -d '(^|.)((yandex|qq|tencent).(net|com|org|dev|io|sh|cn|ru)|qq|local|localhost|query|sl|(^.$))'
