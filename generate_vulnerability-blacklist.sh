#!/bin/bash
source /etc/environment
source $PROG/all-scripts-exports.sh
CONCURRENT

FILTER=/etc/fail2ban/filter.d
TLD_FILE=$HOLE/tld-blacklist.list
IN_FILE=$FILTER/ctp-custom-vars.conf

PIHOLE_REGEX_BLOCKED_QUERY_TYPE=$HOLE/vulnerability-pihole-blocked-query-types.regex
DNSMASQ_CONFIG_FOR_vulnerability_blacklist=$DNSMASQ/14-InfoSec-vulnerability-blacklist.conf

OUT_FILE=$HOLE/vulnerability-blacklist
OUT_FILE_REGEX=$OUT_FILE.regex
OUT_FILE_LIST=$OUT_FILE.list
! [[ -f $OUT_FILE_REGEX ]] && touch $OUT_FILE_REGEX
! [[ -f $OUT_FILE_LIST ]] && touch $OUT_FILE_LIST

IP_REGEX='((([0-9]{1,3}((\\.)?))){4})'
PTR_REGEX="$IP_REGEX\\.in-addr\\.arpa((\\.)?)"

DOMAIN_LENGTH_REGEX=`grep -E ^DOMAIN_LENGTH_REGEX $IN_FILE | awk -F= '{print $2}'`
WILD_CARD_DOMAIN_REGEX=`grep -E ^WILD_CARD_DOMAIN_REGEX $IN_FILE | awk -F= '{print $2}'`

DOMAIN_LENGTH_REGEX=${DOMAIN_LENGTH_REGEX// /}
WILD_CARD_DOMAIN_REGEX=${WILD_CARD_DOMAIN_REGEX// /}
DOMAIN_LENGTH_REGEX_NEW='(^|\\.)'
vulnerability_block_regex=`grep -E ^QUERY_DOMAIN_REGEX_ $IN_FILE | awk -F= '{print $2}'`
vulnerability_block_regex=${vulnerability_block_regex// /}

echo """# Generated by: $scriptName
# Generated at: `date`
# This reduces system resource usage and log output
# InfoSec blocklist because fucking hacker

""" | sudo tee $OUT_FILE_REGEX

echo "$vulnerability_block_regex" | sudo tee -a $OUT_FILE_REGEX

#sed -i 's/)$/)$/gm' $OUT_FILE
#sed -i "s/<WILD_CARD_DOMAIN_REGEX>/$DOMAIN_LENGTH_REGEX_NEW/gm" $OUT_FILE
sed -i "s/^(/$DOMAIN_LENGTH_REGEX_NEW(/gm" $OUT_FILE_REGEX
sed -i "s/(^.$)|//gm" $OUT_FILE_REGEX
sed -i "s/(^\.$)|//gm" $OUT_FILE_REGEX
sed -i "s/(^\\.$)|//gm" $OUT_FILE_REGEX
sed -i "s/<IP_REGEX>/$IP_REGEX/gm" $OUT_FILE_REGEX
sed -i "s/<PTR_REGEX>/$PTR_REGEX/gm" $OUT_FILE_REGEX
sed -i 's/testip\\.internet-census\\.org|//gm' $OUT_FILE_REGEX

perl -0777 -i -pe "s/\./\\./gm" $OUT_FILE_REGEX
perl -0777 -i -pe "s/\./\\./gm" $OUT_FILE_REGEX

CTP_LIST=$WWW/txt_lists/ctp-lists
[[ -f $OUT_FILE_REGEX ]] && [[ -d $CTP_LIST ]] && sudo cp -rf $OUT_FILE_REGEX $CTP_LIST/
[[ -f $OUT_FILE_LIST ]] && [[ -d $CTP_LIST ]] && sudo cp -rf $OUT_FILE_LIST $CTP_LIST/

sleep 2s
if [[ "$IS_MASTER" == 'true' ]] || [[ "$HOSTNAME" == 'ctp-vpn' ]]; then
	[[ -f $OUT_FILE_REGEX ]] && ccat $OUT_FILE_REGEX | parallel $parallel_args_lb echo '{}$' | parallel $parallel_xargs_lb pihole --regex '{}'
	[[ -f $OUT_FILE_LIST ]] && ccat $OUT_FILE_LIST | parallel $parallel_args_lb echo '{}' | parallel $parallel_xargs_lb pihole -b '{}'
	[[ -f $PIHOLE_REGEX_BLOCKED_QUERY_TYPE ]] && ccat $PIHOLE_REGEX_BLOCKED_QUERY_TYPE | parallel --lb -j1 echo '{}' | parallel $parallel_xargs_lb pihole --regex '{}'
	[[ -f $PIHOLE_REGEX_BLOCKED_QUERY_TYPE ]] && ccat $PIHOLE_REGEX_BLOCKED_QUERY_TYPE | parallel --lb -j1 echo '{}' | parallel $parallel_xargs_lb pihole --regex '{}'
	[[ -f $TLD_FILE ]] && ccat $TLD_FILE | parallel --lb -j1 echo '\\{}$' | parallel $parallel_xargs_lb pihole --regex '{}'


	mapfile -t MAJOR_DOMAINS < $OUT_FILE_LIST


	echo """# Generated by: $scriptName
	# Generated at: `date`
	# This reduces system resource usage and log output
	# InfoSec blocklist backup item because fucking hacker
	""" | sudo tee $DNSMASQ_CONFIG_FOR_vulnerability_blacklist

	for domain in "${MAJOR_DOMAINS[@]}"
	do

echo """
local=/$domain/
""" | sudo tee -a $DNSMASQ_CONFIG_FOR_vulnerability_blacklist

	done
fi

pihole --regex -d '(^|.)((yandex|qq|tencent).(net|com|org|dev|io|sh|cn|ru)|qq|local|localhost|query|sl|(^.$))' \
	'(^|.)(jujxeeerdcnm.intranet|w|aolrlgqh.intranet|((.)?)intranet)' \
	'(^|.)(jujxeeerdcnm.ntranet|w|aolrlgqh.ntranet|((.)?)intranet)' \
	'(^|.)((yandex|qq|tencent).(net|com|org|dev|io|sh|cn|ru)|qq|local|localhost|query|sl|(^.$)|cn-geo1.uber.com|metadata.google.internal|((.)?)in-addr.arpa)'

pihole --regex -d '$'
ccat $HOLE/blacklist.regex.remove | parallel $parallel_args_pihole pihole --regex -d
ccat $HOLE/blacklist.list.remove | parallel $parallel_args_pihole pihole -b -d
